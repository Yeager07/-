# Работа #3 - Механика тряпичной куклы в Unity
Отчет по лабораторной работе #3 выполнил(а):
- Есипенко Игорь Ярославович
- РИ-320936
- АТ-09
# Цель работы: освоить создание тряпичной куклы Ragdoll на движке Unity

![image](https://github.com/user-attachments/assets/b2018663-07da-473c-b498-3f5f94fa8b2e)

Рекомендуемые источники для изучения:
1.	Collider Unity Documentation
2.	Тема Ragdoll в материалах лекции

# Задания к работе
# Задание 1 Создание механики тряпичной куклы
1.1 Скачайте любую Humanoid-модель с сайта Mixamo.com в формате FBX for Unity. Можете выбрать сразу модель с анимацией, либо скачать анимацию позднее:

![image](https://github.com/user-attachments/assets/fcb447aa-2818-4765-9501-d53a46e44dee)

1.2 Добавьте модель в проект и на сцену Unity. Работает простое перетаскивание скачанной модели сначала в папку Project Unity, и далее – на сцену.

1.3 При добавлении на сцену модель будет белого цвета. Это происходит из-за отсутствия текстур. Текстуры в файле .fbx есть, но их нужно извлечь, для этого кликните по .fbx файлу и в окне Inspector выбираем Materials - Extract Textures. Появляется окно «Normal Map Settings» - нажимаем «Fix Now». Здесь выводится информация о том, что нужно правильно интерпретировать настройки карт нормали.

## Скачал, добавил Humanoid-модель на сцену и извлёк текстуры

![image](https://github.com/user-attachments/assets/1f32256d-ef6e-4492-a4c4-a88f31c1feef)

1.4 В окне Hierarchy развернем персонажа: ALT (Option) + CLICK по нему. Так будут развернуты все вложенности. Чтобы сделать Ragdoll, нужно выделить каждую часть тела и назначить на нее серию компонентов: Rigidbody + Collider + Joint (шарнир). Для того чтобы сделать это в автоматическом режиме перейдите во вкладку GameObject -> 3D Object -> Ragdoll (инструмент создания тряпичной куклы).

## Окно иерархии персонажа

![image](https://github.com/user-attachments/assets/92d5c753-1cb3-4ca9-b732-d12708772dd2)

1.5 Открывается окно со слотами, которое нужно наполнить частями тела персонажа (перетаскиванием из окна Hierarchy в окно Create Ragdoll). На те части, которых нет в списке - Rigidbody не назначается. В нижней части указывается Total Mass - вес тела, который будет распределен между всеми частями, пропорционально их размерам. Например, в нашем случае ставим вес тела 60 кг:

![image](https://github.com/user-attachments/assets/3c48e9e3-b113-4ce4-a424-5e4b934f9a56)

1.6 Завершите создание тряпичной куклы, подтвердив действие в окне Create Ragdoll. Если выделить самый верх иерархии (в окне Hiararchy) персонажа - то вы увидите автоматически созданные коллайдеры:

![image](https://github.com/user-attachments/assets/75c7e7f7-0901-4d78-9bee-8abe11165626)

## Автоматически созданные коллайдеры

![image](https://github.com/user-attachments/assets/cff3fc32-e005-4465-893a-c8d1c1a25310)

1.7 Запустите сцену. Что не так с механикой? Внесите исправления в автоматически назначенные компоненты, чтобы механика падения тряпичной куклы выглядела более натурально. Дайте развернутый ответ, что требовалось исправить:

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
В работе механики наблюдалась следующая проблема: ноги персонажа резко разъезжались в стороны из-за больших размеров коллайдера (они соприкасались друг с другом, из-за чего происходило резкое выталкивание одного коллайдера из пространства другого). Данная проблема решилась путём изменения радиуса (выставил значение в 0.05) коллайдера у объектов, относящихся к ногам (mixamorig:LeftUpLeg, mixamorig:LeftLeg, mixamorig:RightUpLeg, mixamorig:RightLeg).

## Изменённый радиус у коллайдеров ног на примере LeftUpLeg

![image](https://github.com/user-attachments/assets/dcc2e38e-bc80-401d-8a11-bedbea2a7f1e)

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# Задание 2 Переход между Ragdoll и анимацией персонажа

1.8 Скачайте с сайта Mixamo скелет с анимацией какого-либо движения (если не сделали этого ранее). И добавьте в проект Unity (перетаскиванием в окно Project). Разверните скачанный файл (нажав стрелку рядом с моделью). Файл с анимацией выглядит как треугольник. Извлеките его из пакета, нажав Ctrl+D. Выберите извлеченный файл анимации и сделай так, чтобы она была зациклена (клик Loop Time в окне Inspector)

![image](https://github.com/user-attachments/assets/cc3e628a-1025-4033-b15a-2365d700a1bf)

## пакет модели со скелетом для анимации

![image](https://github.com/user-attachments/assets/165e2160-7a34-42d5-a3fc-4bfa26be0b98)

1.9 Правильный порядок создания анимации выглядит так:
-	создайте контроллер анимации (клик ПКМ в окне Project - Create - Animator Controller)
-	созданный Animator Controller назначьте на модель персонажа на сцене
-	откройте созданный контроллер анимации (дважды кликнув по нему)
-	переместите анимацию из предыдущего пункта в контроллер анимации

![image](https://github.com/user-attachments/assets/1386fb5a-3b2d-4930-94ac-2a1298127540)

## Создал контроллер анимации

![image](https://github.com/user-attachments/assets/1639367c-c042-4d2f-b696-b406cacbbd13)

## Назначил созданный контроллер анимации на персонажа

![image](https://github.com/user-attachments/assets/9a9c4644-ea6b-4674-bc5f-f0d2174103ac)

## Открыл созданный контроллер анимации и переместил анимацию из предыдущего пункта в него

![image](https://github.com/user-attachments/assets/b8324f4f-0721-40a0-b6e1-7fd27088db17)

1.10  При запуске сцены анимация в вашем случае выглядит забагованной. Как вы считаете, почему это происходит? Дайте развернутый ответ:

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
**Решил провести небольшой эксперимент: так как в материалах к работе в качестве примера используется две разных модели (одна в T-позе, вторая – в позе для начала движения); решил для сравнения поставить рядом две модели: одна в T-позе, другая – которая шла со скелетом анимации (на рисунке слева, находится в позе готовности к началу движения). Та модель, что стоит слева – двигается нормально без каких-либо перебоев и глюков. Поэтому, мне кажется, что всё дело в начальной позе модели перед запуском анимации (возможно идёт какой-то сбой/недопонимание в программе из-за разницы координат модели).**

**Upd1: после написания и подключения скрипта для включения режима Ragdoll по нажатию клавиши, анимация стала плавной и перестала баговать, не знаю, с чем это может быть связано… либо с тем, что аниматор начинает использоваться где-то ещё помимо модели, но при отключении скрипта от модели, анимация по прежнему продолжает плавно воспроизводиться.**

**Upd2: поиграв с данными массива allRigidbodys понял, что при добавлении в него элементов анимация становится плавной и перестаёт баговать, получается, что элементы, добавленные в этот массив перестают быть необработанными или что-то в этом духе, потому что даже если в массиве будет всего одни-два элемента, анимация всё равно будет багованная; иначе говоря, весь этот учёт элементов частей модели в массиве каким-то образом влияет на воспроизведение анимации.**
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Две различные модели (T-поза и поза готовности к движению).

![image](https://github.com/user-attachments/assets/6e338fd3-daa8-4dc0-b5d9-5415ef0ce2ec)

1.11 Создадим скрипт файл RagdollControl.cs, который будет отключать анимацию и включать механику тряпичной куклы. Описание скрипта: 
-	Скрипт RagdollControl.cs навешивается на персонажа. Скрипт будет содержать две переменные: 
-	Animator для управления анимацией
-	Массив Rigidbodies, который будет отключаться
-	Когда скрипт будет написан и подключен, в поле переменной Animator подключается Animator в пределах поля Inspector.
-	Массив All Rigidbodies нужно заполнить всеми rigid bodies модели: чтобы это сделать удобно нужно нажать замок на инспекторе персонажа. 
-	 В окне иерархии выделить все внутренности персонажа (через shift) и перетащить на массив в инспекторе.
-	Так будут добавлены все rigidbodies этого персонажа.

Содержание скрипта, отключающего анимацию показано ниже:

```C#
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class ScriptRagdollOff : MonoBehaviour
{
    public Animator animator;
    public Rigidbody [] allRigidbodies;

    private void Awake()
    {
        for (int i = 0; i < allRigidbodies.Length; i++)
        {
            allRigidbodies[i].isKinematic = true;
        }
    }

    void Update()
    {
        if (Input.GetKeyDown(KeyCode.Space))
        {
            MakePhysics();
        }
    }

    public void MakePhysics()
    {
        animator.enabled = false;
        for (int i = 0; i < allRigidbodies.Length; i++)
        {
            allRigidbodies[i].isKinematic = false;
        }
    }
}
```

## Создал скрипт RigdollControl, применил его на персонаже и добавил в массив нужные части персонажа

![image](https://github.com/user-attachments/assets/dd8ef4aa-06a4-48ad-9b39-7b81206210c1)

1.12 Что произойдет, если не все Rigidbody тряпичной куклы будут отключены? Дайте развернутый ответ.

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Мне кажется, что если не все Rigidbody тряпичной куклы будут отключены, произойдёт следующее: те части, у которых Rigidbody не будут отключены, продолжат отыгрывать анимацию, а те, у которых Rigidbody отключён – перестанут двигаться и будут просто болтаться за теми частями, которые до сих пор находятся в движении.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

1.12 Напишите развернутый вывод по проделанной работе. Как знания свойств компонентов Collider помогут в создании интерактивных приложений, игр и симуляторов?

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
В ходе данной лабораторной работы были изучены основные способы работы с таким компонентом как Ragdoll. Также была проведена работа по скачиванию и добавлению 3D-моделей и их анимаций в проект Unity. С помощью скрипта была настроена функция включения Ragdoll’а по нажатию указанной клавиши. В дальнейшем данные знания могут помочь в создании различных механик, например убийства персонажа, но уже не при нажатии какой-то клавиши, а при пересечении коллайдеров двух моделей (например коллайдер головы и коллайдер пули); по нажатии на клавишу можно сделать следующую механику: проанализировать, в каком направлении и как именно будет “падать” модель, если на неё применить Ragdoll, можно будет создать интересные и смешные анимации падения куклы.
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
